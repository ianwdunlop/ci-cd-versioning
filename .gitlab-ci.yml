stages:
  - ensure-build
  - release
  - build

release:
  stage: release
  image: debian:buster
  before_script:
    - apt-get update -yqq && apt-get install -yqq apt-transport-https ca-certificates curl gnupg git bc
  script:
    - . ./common/setup-git.sh
    - PREVIOUS_TAG=$(./common/previous-tag.sh)
    - GIT_LOG=$(./common/git-log.sh $PREVIOUS_TAG)
    - BUMP=$(./common/bump.sh $PREVIOUS_TAG)
    - RELEASE_TAG=$(./common/next-tag.sh $PREVIOUS_TAG $BUMP)
    - . ./common/version.sh
    - . ./common/create-release.sh
    - . ./common/rebase.sh
  only:
    - master
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

default:
  tags:
    - wopr
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json

common:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile common/Dockerfile \
      --destination $CI_REGISTRY_IMAGE:latest \
      --destination $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

golang:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile golang/Dockerfile \
      --destination $CI_REGISTRY_IMAGE/golang:latest \
      --destination $CI_REGISTRY_IMAGE/golang:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

scala:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile scala/Dockerfile \
      --destination $CI_REGISTRY_IMAGE/scala:latest \
      --destination $CI_REGISTRY_IMAGE/scala:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

python:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile \
      --destination $CI_REGISTRY_IMAGE/python:latest \
      --destination $CI_REGISTRY_IMAGE/python:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

python3.6:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile \
      --build-arg TAG=3.6 \
      --destination $CI_REGISTRY_IMAGE/python:3.6 \
      --destination $CI_REGISTRY_IMAGE/python:3.6-$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

node:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile node/Dockerfile \
      --destination $CI_REGISTRY_IMAGE/node:latest \
      --destination $CI_REGISTRY_IMAGE/node:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

ensure-common:
  stage: ensure-build
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile common/Dockerfile --no-push
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

ensure-golang:
  stage: ensure-build
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile golang/Dockerfile --no-push
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

ensure-scala:
  stage: ensure-build
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile scala/Dockerfile --no-push
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

ensure-python:
  stage: ensure-build
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile --no-push
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

ensure-python3.6:
  stage: ensure-build
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile --build-arg TAG=3.6 --no-push
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

ensure-node:
  stage: ensure-build
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile node/Dockerfile --no-push
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/