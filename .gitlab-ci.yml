stages:
  - test
  - build-dev
  - release
  - build

lint:
  stage: test
  image: python:latest
  before_script:
    - pip install -r requirements.txt
    - pip install -r requirements.dev.txt
  script:
    - pylint lib cictl

test:
  stage: test
  image: python:latest
  before_script:
    - pip install -r requirements.txt
    - pip install -r requirements.dev.txt
  script:
    - python -m pytest --cov-report term:skip-covered --cov=lib tests/
  coverage: '/TOTAL.*\s+(\d+%)$/'

release:
  stage: release
  image: registry.mdcatapult.io/informatics/docker-images/runners/debian
  before_script:
    - apt-get update -yqq && apt-get install -yqq build-essential apt-transport-https ca-certificates curl gnupg git bc jq wget git-lfs python3 python3-pip
    - pip3 install -r requirements.txt
  script:
    - ./cictl exec release
  only:
    - master
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

default:
  tags:
    - wopr
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json

debian:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile debian/Dockerfile \
      --destination $CI_REGISTRY_IMAGE/debian:latest \
      --destination $CI_REGISTRY_IMAGE/debian:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

golang:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile golang/Dockerfile \
      --destination $CI_REGISTRY_IMAGE/golang:latest \
      --destination $CI_REGISTRY_IMAGE/golang:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

sbt:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile sbt/Dockerfile \
      --destination $CI_REGISTRY_IMAGE/sbt:latest \
      --destination $CI_REGISTRY_IMAGE/sbt:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

sbt-jdk14:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile sbt/Dockerfile \
      --build-arg TAG=jdk14 \
      --destination $CI_REGISTRY_IMAGE/sbt:jdk14 \
      --destination $CI_REGISTRY_IMAGE/sbt:jdk14-$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

python:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile \
      --destination $CI_REGISTRY_IMAGE/python:latest \
      --destination $CI_REGISTRY_IMAGE/python:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

python3.6:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile \
      --build-arg TAG=3.6 \
      --destination $CI_REGISTRY_IMAGE/python:3.6 \
      --destination $CI_REGISTRY_IMAGE/python:3.6-$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

python3.7:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile \
      --build-arg TAG=3.7 \
      --destination $CI_REGISTRY_IMAGE/python:3.7 \
      --destination $CI_REGISTRY_IMAGE/python:3.7-$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

node:
  stage: build
  script:
    - |
      /kaniko/executor --context $CI_PROJECT_DIR --dockerfile node/Dockerfile \
      --destination $CI_REGISTRY_IMAGE/node:latest \
      --destination $CI_REGISTRY_IMAGE/node:$CI_COMMIT_REF_NAME
  only:
    refs:
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

debian-dev:
  stage: build-dev
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile debian/Dockerfile --destination $CI_REGISTRY_IMAGE/debian:$CI_COMMIT_REF_SLUG
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

golang-dev:
  stage: build-dev
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile golang/Dockerfile --destination $CI_REGISTRY_IMAGE/golang:$CI_COMMIT_REF_SLUG
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

sbt-dev:
  stage: build-dev
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile sbt/Dockerfile --destination $CI_REGISTRY_IMAGE/sbt:$CI_COMMIT_REF_SLUG
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

sbt-jdk14-dev:
  stage: build-dev
  script:
    - /kaniko/executor --build-arg TAG=jdk14 --context $CI_PROJECT_DIR --dockerfile sbt/Dockerfile --destination $CI_REGISTRY_IMAGE/sbt:jdk14-$CI_COMMIT_REF_SLUG
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

python-dev:
  stage: build-dev
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile --destination $CI_REGISTRY_IMAGE/python:$CI_COMMIT_REF_SLUG
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

python3.6-dev:
  stage: build-dev
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile --build-arg TAG=3.6 --destination $CI_REGISTRY_IMAGE/python:3.6-$CI_COMMIT_REF_SLUG
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

python3.7-dev:
  stage: build-dev
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile python/Dockerfile --build-arg TAG=3.7 --destination $CI_REGISTRY_IMAGE/python:3.7-$CI_COMMIT_REF_SLUG
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/

node-dev:
  stage: build-dev
  script:
    - /kaniko/executor --context $CI_PROJECT_DIR --dockerfile node/Dockerfile --destination $CI_REGISTRY_IMAGE/node:$CI_COMMIT_REF_SLUG
  except:
    refs:
      - master
      - tags
    variables:
      - $CI_COMMIT_MESSAGE =~ /^Setting version to.*/